---
title: "Untitled"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(here)
library(brms)
library(tidybayes)
library(patchwork)
library(cmdstanr)
library(ggh4x)
```

```{r}
# gglot theme
theme_andi <- function(){
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        axis.line = element_line(colour = "black" ))
}
```

## Get data

```{r}
#get data for both sites
dat_mort_E2B <- read.csv(here("size/data/dat_mort_E2B.csv"))
dat_mort_HAA <- read.csv(here("size/data/dat_mort_HAA.csv"))

#and combine
dat_mort <- bind_rows(dat_mort_HAA, dat_mort_E2B)
```

### Clean data

```{r}
# subset columns
dat_size <- dat_mort %>% 
  select(site, quadrat, ID, spec_1, comparison, area_1, area_2)

#make new data frame for 2022 data (otherwise, "hidden" in comparison 2020 - 2022)
dat_size_2022 <- dat_size %>% 
  filter(comparison == "2020_2022") %>% 
  mutate(log_area = log(1+area_2),
         year = 2022) %>% 
  select(site, quadrat, ID, spec_1, log_area, year)

dat_size <- dat_size %>% 
  mutate(log_area = log(1+area_1)) %>% 
  mutate(year = as.numeric(substr(comparison,1,4))) %>% 
  select(site, quadrat, ID, spec_1, year, log_area)


dat_size <- bind_rows(dat_size, dat_size_2022) %>% 
  rename(spec = spec_1)

```

### Plot

```{r}
cols_years <- c("2016" = "#E69F00",
                "2018" = "#56B4E9",
                "2020" = "#009E73",
                "2022" = "#D55E00")

x_seq <- log(c(0, 2,  10, 50, 250, 1000)+1)
x_seq_trans <- round(exp(x_seq)-1,0)

plot_size_distr <- dat_size %>% 
  mutate(site = recode(site, 
                       "HAA" = "Haapiti",
                       "E2B" = "Pihaena")) %>% 
  filter(spec == "Pocillopora") %>% 
  ggplot(aes(x = log_area))+
  geom_density(aes(col = factor(year)), linewidth = 0.7)+
  geom_density(aes(fill = factor(year)), alpha = .3, col = NA)+
  facet_wrap2(~site, axes = "all") +
  scale_colour_manual(values = cols_years, name = NULL)+
  scale_fill_manual(values = cols_years, name = NULL)+
  scale_x_continuous(breaks = x_seq, 
                     labels = x_seq_trans)+
  labs(x = expression("Colony area"~cm^2), y = NULL)+
  theme_andi()+
  #theme_minimal()+
  theme(legend.position = "bottom")
plot_size_distr
```

Save plot

```{r}
ggsave(filename = "size_distribution.pdf",
       plot = plot_size_distr, 
       path = here("size/plots"),
       width = 16, height = 9, units = "cm")
```
